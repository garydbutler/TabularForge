<UserControl x:Class="TabularForge.UI.Views.TomExplorerPanel"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:models="clr-namespace:TabularForge.Core.Models;assembly=TabularForge.Core"
             xmlns:conv="clr-namespace:TabularForge.UI.Converters"
             mc:Ignorable="d"
             Background="{DynamicResource SideBarBackground}">

    <UserControl.Resources>
        <conv:BoolToVisibilityConverter x:Key="BoolToVis" />
        <conv:ObjectTypeToIconConverter x:Key="TypeToIcon" />
        <conv:ObjectTypeToColorConverter x:Key="TypeToColor" />

        <!-- Hierarchical data template for the tree -->
        <HierarchicalDataTemplate DataType="{x:Type models:TomNode}"
                                   ItemsSource="{Binding Children}">
            <StackPanel Orientation="Horizontal" Margin="1,1"
                        Visibility="{Binding IsVisible, Converter={StaticResource BoolToVis}}">
                <!-- Icon: Path geometry drawn from converter -->
                <Canvas Width="16" Height="16" Margin="0,0,4,0">
                    <Path Data="{Binding ObjectType, Converter={StaticResource TypeToIcon}}"
                          Stroke="{Binding ObjectType, Converter={StaticResource TypeToColor}}"
                          StrokeThickness="1.3" Fill="Transparent"
                          Width="16" Height="16" Stretch="Uniform" />
                </Canvas>

                <!-- Name -->
                <TextBlock Text="{Binding Name}" VerticalAlignment="Center"
                           Foreground="{DynamicResource PrimaryText}"
                           FontSize="12.5">
                    <TextBlock.Style>
                        <Style TargetType="TextBlock">
                            <Setter Property="FontStyle" Value="Normal" />
                            <Setter Property="Opacity" Value="1" />
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding IsHidden}" Value="True">
                                    <Setter Property="FontStyle" Value="Italic" />
                                    <Setter Property="Opacity" Value="0.5" />
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </TextBlock.Style>
                </TextBlock>

                <!-- Data type indicator for columns -->
                <TextBlock Text="{Binding DataType}" Margin="6,0,0,0"
                           Foreground="{DynamicResource SecondaryText}"
                           FontSize="10" VerticalAlignment="Center"
                           Visibility="{Binding DataType, Converter={StaticResource BoolToVis}}" />
            </StackPanel>
        </HierarchicalDataTemplate>
    </UserControl.Resources>

    <DockPanel>
        <!-- Search Bar -->
        <Border DockPanel.Dock="Top" Padding="4" Background="{DynamicResource SideBarBackground}">
            <Grid>
                <TextBox Text="{Binding SearchText, UpdateSourceTrigger=PropertyChanged}"
                         Padding="4,4,24,4" FontSize="12"
                         Background="{DynamicResource InputBackground}"
                         Foreground="{DynamicResource InputText}"
                         BorderBrush="{DynamicResource InputBorderBrush}"
                         Tag="Search objects... (Ctrl+F)" />
                <TextBlock Text="ðŸ”" HorizontalAlignment="Right"
                           VerticalAlignment="Center" Margin="0,0,6,0"
                           FontSize="12" IsHitTestVisible="False"
                           Foreground="{DynamicResource SecondaryText}" />
            </Grid>
        </Border>

        <!-- Toolbar -->
        <Border DockPanel.Dock="Top" Padding="2"
                Background="{DynamicResource SideBarBackground}"
                BorderBrush="{DynamicResource BorderBrush}" BorderThickness="0,0,0,1">
            <StackPanel Orientation="Horizontal">
                <Button Command="{Binding ExpandAllCommand}" ToolTip="Expand All"
                        Padding="4,2" FontSize="11">
                    <TextBlock Text="âŠž" />
                </Button>
                <Button Command="{Binding CollapseAllCommand}" ToolTip="Collapse All"
                        Padding="4,2" FontSize="11">
                    <TextBlock Text="âŠŸ" />
                </Button>
                <Border Width="1" Background="{DynamicResource SeparatorBrush}" Margin="4,2" />
                <Button Command="{Binding ToggleHiddenCommand}" ToolTip="Toggle Hidden (Ctrl+I)"
                        Padding="4,2" FontSize="11">
                    <TextBlock Text="ðŸ‘" />
                </Button>
            </StackPanel>
        </Border>

        <!-- Tree View -->
        <TreeView x:Name="TomTree"
                  ItemsSource="{Binding ModelRoot.Children}"
                  Background="{DynamicResource SideBarBackground}"
                  BorderThickness="0"
                  VirtualizingPanel.IsVirtualizing="True"
                  VirtualizingPanel.VirtualizationMode="Recycling"
                  SelectedItemChanged="TomTree_SelectedItemChanged">

            <TreeView.ItemContainerStyle>
                <Style TargetType="TreeViewItem">
                    <Setter Property="IsExpanded" Value="{Binding IsExpanded, Mode=TwoWay}" />
                    <Setter Property="IsSelected" Value="{Binding IsSelected, Mode=TwoWay}" />
                    <Setter Property="Visibility" Value="{Binding IsVisible, Converter={StaticResource BoolToVis}}" />
                    <Setter Property="Foreground" Value="{DynamicResource PrimaryText}" />
                    <Setter Property="Padding" Value="2,1" />
                    <Setter Property="ContextMenu">
                        <Setter.Value>
                            <ContextMenu Background="{DynamicResource PopupBackground}"
                                         Foreground="{DynamicResource PrimaryText}"
                                         BorderBrush="{DynamicResource PopupBorderBrush}">
                                <MenuItem Header="Rename" Command="{Binding DataContext.RenameNodeCommand,
                                    RelativeSource={RelativeSource AncestorType=Window}}"
                                          InputGestureText="F2" />
                                <MenuItem Header="Duplicate" Command="{Binding DataContext.DuplicateNodeCommand,
                                    RelativeSource={RelativeSource AncestorType=Window}}" />
                                <Separator />
                                <MenuItem Header="Toggle Hidden" Command="{Binding DataContext.ToggleHiddenCommand,
                                    RelativeSource={RelativeSource AncestorType=Window}}"
                                          InputGestureText="Ctrl+I" />
                                <MenuItem Header="Show Dependencies" Command="{Binding DataContext.ShowDependenciesCommand,
                                    RelativeSource={RelativeSource AncestorType=Window}}"
                                          InputGestureText="Shift+F12" />
                                <Separator />
                                <MenuItem Header="Delete" Command="{Binding DataContext.DeleteNodeCommand,
                                    RelativeSource={RelativeSource AncestorType=Window}}"
                                          InputGestureText="Del"
                                          Foreground="{DynamicResource ErrorText}" />
                            </ContextMenu>
                        </Setter.Value>
                    </Setter>
                    <Style.Triggers>
                        <Trigger Property="IsSelected" Value="True">
                            <Setter Property="Background" Value="{DynamicResource SelectionBrush}" />
                        </Trigger>
                        <Trigger Property="IsMouseOver" Value="True">
                            <Setter Property="Background" Value="{DynamicResource HoverBrush}" />
                        </Trigger>
                    </Style.Triggers>
                </Style>
            </TreeView.ItemContainerStyle>
        </TreeView>
    </DockPanel>
</UserControl>
