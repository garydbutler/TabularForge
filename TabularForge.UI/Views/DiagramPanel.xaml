<UserControl x:Class="TabularForge.UI.Views.DiagramPanel"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:conv="clr-namespace:TabularForge.UI.Converters"
             Background="{DynamicResource EditorBackground}"
             Foreground="{DynamicResource PrimaryText}">

    <UserControl.Resources>
        <conv:BoolToOpacityConverter x:Key="BoolToOpacity" />
        <conv:BoolToLineStyleConverter x:Key="BoolToLineStyle" />
        <conv:StringToBrushConverter x:Key="StringToBrush" />
        <conv:BoolToFontWeightConverter x:Key="BoolToFontWeight" />
    </UserControl.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
            <RowDefinition Height="Auto" />
        </Grid.RowDefinitions>

        <!-- Toolbar -->
        <Border Grid.Row="0" Background="{DynamicResource ToolBarBackground}"
                BorderBrush="{DynamicResource BorderBrush}" BorderThickness="0,0,0,1"
                Padding="4,2">
            <WrapPanel Orientation="Horizontal">
                <!-- Layout -->
                <TextBlock Text="Layout:" VerticalAlignment="Center" Margin="4,0,4,0" FontSize="12" />
                <ComboBox x:Name="LayoutCombo" Width="120" FontSize="11" Margin="0,0,4,0"
                          SelectedIndex="0" SelectionChanged="LayoutCombo_SelectionChanged">
                    <ComboBoxItem Content="Tree / Grid" />
                    <ComboBoxItem Content="Force-Directed" />
                    <ComboBoxItem Content="Hierarchical" />
                </ComboBox>
                <Button Content="Apply Layout" Command="{Binding ApplyLayoutCommand}"
                        Padding="8,4" Margin="2,0" FontSize="12" />

                <Border Width="1" Background="{DynamicResource SeparatorBrush}" Margin="6,2" />

                <!-- Zoom -->
                <Button Content="-" Command="{Binding ZoomOutCommand}"
                        Padding="8,4" Margin="2,0" FontSize="12" FontWeight="Bold" Width="28" />
                <TextBlock Text="{Binding ZoomLevel, StringFormat='{}{0:P0}'}"
                           VerticalAlignment="Center" Margin="4,0" FontSize="11" Width="40"
                           TextAlignment="Center" />
                <Button Content="+" Command="{Binding ZoomInCommand}"
                        Padding="8,4" Margin="2,0" FontSize="12" FontWeight="Bold" Width="28" />
                <Button Content="Fit" Command="{Binding ZoomFitCommand}"
                        Padding="8,4" Margin="2,0" FontSize="12" />
                <Button Content="1:1" Command="{Binding ZoomResetCommand}"
                        Padding="8,4" Margin="2,0" FontSize="12" />

                <Border Width="1" Background="{DynamicResource SeparatorBrush}" Margin="6,2" />

                <!-- Options -->
                <CheckBox Content="Snap to Grid" IsChecked="{Binding SnapToGrid}"
                          VerticalAlignment="Center" Margin="4,0" FontSize="11" />
                <CheckBox Content="Minimap" IsChecked="{Binding ShowMinimap}"
                          VerticalAlignment="Center" Margin="4,0" FontSize="11" />

                <Border Width="1" Background="{DynamicResource SeparatorBrush}" Margin="6,2" />

                <!-- Layouts -->
                <TextBlock Text="Diagram:" VerticalAlignment="Center" Margin="4,0,4,0" FontSize="12" />
                <ComboBox ItemsSource="{Binding SavedLayouts}" SelectedItem="{Binding ActiveLayout}"
                          DisplayMemberPath="Name" Width="100" FontSize="11" Margin="0,0,4,0" />
                <Button Content="Save" Command="{Binding SaveCurrentLayoutCommand}"
                        Padding="8,4" Margin="2,0" FontSize="12" />
                <Button Content="New" Command="{Binding NewLayoutCommand}"
                        Padding="8,4" Margin="2,0" FontSize="12" />

                <Border Width="1" Background="{DynamicResource SeparatorBrush}" Margin="6,2" />

                <!-- Export -->
                <Button Content="Export PNG" Click="ExportPng_Click"
                        Padding="8,4" Margin="2,0" FontSize="12" />
            </WrapPanel>
        </Border>

        <!-- Main Diagram Canvas -->
        <Grid Grid.Row="1" ClipToBounds="True">
            <!-- Canvas with zoom/pan transform -->
            <ScrollViewer x:Name="DiagramScroller"
                          HorizontalScrollBarVisibility="Auto"
                          VerticalScrollBarVisibility="Auto"
                          Background="{DynamicResource EditorBackground}"
                          PreviewMouseWheel="DiagramScroller_PreviewMouseWheel"
                          PreviewMouseDown="DiagramCanvas_MouseDown"
                          PreviewMouseMove="DiagramCanvas_MouseMove"
                          PreviewMouseUp="DiagramCanvas_MouseUp">
                <Canvas x:Name="DiagramCanvas"
                        Width="{Binding CanvasWidth}"
                        Height="{Binding CanvasHeight}"
                        Background="Transparent"
                        ClipToBounds="False">
                    <Canvas.LayoutTransform>
                        <ScaleTransform ScaleX="{Binding ZoomLevel}" ScaleY="{Binding ZoomLevel}" />
                    </Canvas.LayoutTransform>

                    <!-- Grid dots (drawn in code-behind) -->
                    <!-- Relationship lines (drawn in code-behind) -->
                    <!-- Table cards (rendered via ItemsControl overlay) -->
                </Canvas>
            </ScrollViewer>

            <!-- No model placeholder -->
            <TextBlock Text="Open a .bim file or connect to a server to view the diagram."
                       HorizontalAlignment="Center" VerticalAlignment="Center"
                       FontSize="16" Opacity="0.5"
                       Visibility="{Binding IsModelLoaded, Converter={StaticResource InverseBoolToVis}}" />

            <!-- Minimap overlay -->
            <Border x:Name="MinimapBorder"
                    Width="200" Height="150"
                    HorizontalAlignment="Right" VerticalAlignment="Bottom"
                    Margin="0,0,12,12"
                    Background="#CC1E1E1E"
                    BorderBrush="{DynamicResource BorderBrush}" BorderThickness="1"
                    CornerRadius="4"
                    Visibility="{Binding ShowMinimap, Converter={StaticResource BoolToVis}}">
                <Canvas x:Name="MinimapCanvas" ClipToBounds="True" />
            </Border>

            <!-- Relationship properties popup -->
            <Border x:Name="RelationshipPopup"
                    Visibility="Collapsed"
                    HorizontalAlignment="Center" VerticalAlignment="Bottom"
                    Margin="0,0,0,12"
                    Background="{DynamicResource PanelBackground}"
                    BorderBrush="{DynamicResource AccentBrush}" BorderThickness="1"
                    CornerRadius="4" Padding="12">
                <StackPanel>
                    <TextBlock Text="Relationship Properties" FontWeight="Bold" FontSize="13" Margin="0,0,0,8" />
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto" />
                            <ColumnDefinition Width="*" />
                        </Grid.ColumnDefinitions>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto" />
                            <RowDefinition Height="Auto" />
                            <RowDefinition Height="Auto" />
                            <RowDefinition Height="Auto" />
                            <RowDefinition Height="Auto" />
                            <RowDefinition Height="Auto" />
                        </Grid.RowDefinitions>

                        <TextBlock Grid.Row="0" Grid.Column="0" Text="From:" Margin="0,2,8,2" />
                        <TextBlock Grid.Row="0" Grid.Column="1"
                                   Text="{Binding SelectedRelationship.FromTable}" FontWeight="Bold" Margin="0,2" />

                        <TextBlock Grid.Row="1" Grid.Column="0" Text="Column:" Margin="0,2,8,2" />
                        <TextBlock Grid.Row="1" Grid.Column="1"
                                   Text="{Binding SelectedRelationship.FromColumn}" Margin="0,2" />

                        <TextBlock Grid.Row="2" Grid.Column="0" Text="To:" Margin="0,2,8,2" />
                        <TextBlock Grid.Row="2" Grid.Column="1"
                                   Text="{Binding SelectedRelationship.ToTable}" FontWeight="Bold" Margin="0,2" />

                        <TextBlock Grid.Row="3" Grid.Column="0" Text="Column:" Margin="0,2,8,2" />
                        <TextBlock Grid.Row="3" Grid.Column="1"
                                   Text="{Binding SelectedRelationship.ToColumn}" Margin="0,2" />

                        <TextBlock Grid.Row="4" Grid.Column="0" Text="Cardinality:" Margin="0,2,8,2" />
                        <TextBlock Grid.Row="4" Grid.Column="1"
                                   Text="{Binding SelectedRelationship.DisplayCardinality}" Margin="0,2" />

                        <TextBlock Grid.Row="5" Grid.Column="0" Text="Active:" Margin="0,2,8,2" />
                        <CheckBox Grid.Row="5" Grid.Column="1"
                                  IsChecked="{Binding SelectedRelationship.IsActive}" Margin="0,2" />
                    </Grid>

                    <StackPanel Orientation="Horizontal" Margin="0,8,0,0">
                        <Button Content="Toggle Active" Command="{Binding ToggleRelationshipActiveCommand}"
                                Padding="8,4" Margin="0,0,4,0" FontSize="11" />
                        <Button Content="Delete" Command="{Binding DeleteRelationshipCommand}"
                                Padding="8,4" FontSize="11" Foreground="#D9534F" />
                    </StackPanel>
                </StackPanel>
            </Border>
        </Grid>

        <!-- Status Bar -->
        <Border Grid.Row="2" Background="{DynamicResource StatusBarBackground}"
                Padding="6,3">
            <StackPanel Orientation="Horizontal">
                <TextBlock Text="{Binding StatusText}" Foreground="White" FontSize="11" Margin="0,0,16,0" />
                <TextBlock Text="{Binding ZoomLevel, StringFormat='Zoom: {0:P0}'}"
                           Foreground="White" FontSize="11" Margin="0,0,16,0" />
                <TextBlock Foreground="White" FontSize="11">
                    <TextBlock.Text>
                        <MultiBinding StringFormat="Grid: {0}">
                            <Binding Path="GridSize" />
                        </MultiBinding>
                    </TextBlock.Text>
                </TextBlock>
            </StackPanel>
        </Border>
    </Grid>
</UserControl>
