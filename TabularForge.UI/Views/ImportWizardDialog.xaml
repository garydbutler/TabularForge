<Window x:Class="TabularForge.UI.Views.ImportWizardDialog"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:vm="clr-namespace:TabularForge.UI.ViewModels"
        d:DataContext="{d:DesignInstance vm:ImportWizardViewModel}"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        mc:Ignorable="d"
        Title="Import Table Wizard"
        Height="650" Width="850"
        WindowStartupLocation="CenterOwner"
        Background="{DynamicResource WindowBackground}"
        Foreground="{DynamicResource PrimaryText}">

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
            <RowDefinition Height="Auto" />
        </Grid.RowDefinitions>

        <!-- Header -->
        <Border Grid.Row="0" Background="{DynamicResource PanelHeaderBackground}"
                Padding="16,12" BorderBrush="{DynamicResource BorderBrush}" BorderThickness="0,0,0,1">
            <StackPanel>
                <TextBlock Text="Import Table Wizard" FontSize="18" FontWeight="SemiBold" />
                <TextBlock Text="{Binding StatusText}" Foreground="{DynamicResource SecondaryText}"
                           FontSize="12" Margin="0,4,0,0" />
            </StackPanel>
        </Border>

        <!-- Step Content -->
        <Grid Grid.Row="1" Margin="16">

            <!-- Step 0: Select Source -->
            <StackPanel Visibility="{Binding CurrentStep, Converter={StaticResource StepToVis}, ConverterParameter=0}">
                <TextBlock Text="Select Data Source Type" FontSize="14" FontWeight="SemiBold" Margin="0,0,0,12" />

                <RadioButton GroupName="SourceType" Content="SQL Server"
                             IsChecked="{Binding SelectedSourceType, Converter={StaticResource EnumToBool}, ConverterParameter=SqlServer}"
                             Foreground="{DynamicResource PrimaryText}" Margin="8,6" FontSize="13" />
                <RadioButton GroupName="SourceType" Content="Azure SQL Database"
                             IsChecked="{Binding SelectedSourceType, Converter={StaticResource EnumToBool}, ConverterParameter=AzureSql}"
                             Foreground="{DynamicResource PrimaryText}" Margin="8,6" FontSize="13" />
                <RadioButton GroupName="SourceType" Content="CSV File"
                             IsChecked="{Binding SelectedSourceType, Converter={StaticResource EnumToBool}, ConverterParameter=CsvFile}"
                             Foreground="{DynamicResource PrimaryText}" Margin="8,6" FontSize="13" />
                <RadioButton GroupName="SourceType" Content="Excel File"
                             IsChecked="{Binding SelectedSourceType, Converter={StaticResource EnumToBool}, ConverterParameter=ExcelFile}"
                             Foreground="{DynamicResource PrimaryText}" Margin="8,6" FontSize="13" />
                <RadioButton GroupName="SourceType" Content="OData Feed"
                             IsChecked="{Binding SelectedSourceType, Converter={StaticResource EnumToBool}, ConverterParameter=OData}"
                             Foreground="{DynamicResource PrimaryText}" Margin="8,6" FontSize="13" />
                <RadioButton GroupName="SourceType" Content="Blank Table"
                             IsChecked="{Binding SelectedSourceType, Converter={StaticResource EnumToBool}, ConverterParameter=BlankTable}"
                             Foreground="{DynamicResource PrimaryText}" Margin="8,6" FontSize="13" />
            </StackPanel>

            <!-- Step 1: Configure Connection -->
            <ScrollViewer Visibility="{Binding CurrentStep, Converter={StaticResource StepToVis}, ConverterParameter=1}"
                          VerticalScrollBarVisibility="Auto">
                <StackPanel>
                    <TextBlock Text="Configure Connection" FontSize="14" FontWeight="SemiBold" Margin="0,0,0,12" />

                    <!-- SQL Server / Azure SQL -->
                    <StackPanel Visibility="{Binding Connection.SourceType, Converter={StaticResource EnumToBool}, ConverterParameter=SqlServer}">
                        <TextBlock Text="Server:" Margin="0,4" />
                        <TextBox Text="{Binding Connection.Server, UpdateSourceTrigger=PropertyChanged}"
                                 Margin="0,2,0,8" Padding="6,4"
                                 Background="{DynamicResource EditorBackground}"
                                 Foreground="{DynamicResource PrimaryText}" />

                        <TextBlock Text="Database:" Margin="0,4" />
                        <TextBox Text="{Binding Connection.Database, UpdateSourceTrigger=PropertyChanged}"
                                 Margin="0,2,0,8" Padding="6,4"
                                 Background="{DynamicResource EditorBackground}"
                                 Foreground="{DynamicResource PrimaryText}" />

                        <CheckBox Content="Use Windows Authentication"
                                  IsChecked="{Binding Connection.UseWindowsAuth}"
                                  Foreground="{DynamicResource PrimaryText}" Margin="0,4" />

                        <StackPanel Visibility="{Binding Connection.UseWindowsAuth, Converter={StaticResource InverseBoolToVis}}">
                            <TextBlock Text="Username:" Margin="0,4" />
                            <TextBox Text="{Binding Connection.Username, UpdateSourceTrigger=PropertyChanged}"
                                     Margin="0,2,0,8" Padding="6,4"
                                     Background="{DynamicResource EditorBackground}"
                                     Foreground="{DynamicResource PrimaryText}" />
                            <TextBlock Text="Password:" Margin="0,4" />
                            <PasswordBox Margin="0,2,0,8" Padding="6,4"
                                         Background="{DynamicResource EditorBackground}"
                                         Foreground="{DynamicResource PrimaryText}" />
                        </StackPanel>
                    </StackPanel>

                    <!-- CSV / Excel -->
                    <StackPanel Visibility="{Binding Connection.SourceType, Converter={StaticResource EnumToBool}, ConverterParameter=CsvFile}">
                        <TextBlock Text="File Path:" Margin="0,4" />
                        <DockPanel Margin="0,2,0,8">
                            <Button DockPanel.Dock="Right" Content="Browse..."
                                    Command="{Binding BrowseFileCommand}"
                                    Padding="12,4" Margin="4,0,0,0" />
                            <TextBox Text="{Binding Connection.FilePath, UpdateSourceTrigger=PropertyChanged}"
                                     Padding="6,4"
                                     Background="{DynamicResource EditorBackground}"
                                     Foreground="{DynamicResource PrimaryText}" />
                        </DockPanel>
                    </StackPanel>

                    <!-- OData -->
                    <StackPanel Visibility="{Binding Connection.SourceType, Converter={StaticResource EnumToBool}, ConverterParameter=OData}">
                        <TextBlock Text="OData URL:" Margin="0,4" />
                        <TextBox Text="{Binding Connection.OdataUrl, UpdateSourceTrigger=PropertyChanged}"
                                 Margin="0,2,0,8" Padding="6,4"
                                 Background="{DynamicResource EditorBackground}"
                                 Foreground="{DynamicResource PrimaryText}" />
                    </StackPanel>

                    <!-- Test Connection -->
                    <StackPanel Orientation="Horizontal" Margin="0,12,0,0">
                        <Button Content="Test Connection" Command="{Binding TestConnectionCommand}"
                                Padding="12,6" />
                        <TextBlock Text="{Binding Connection.ConnectionStatus}"
                                   VerticalAlignment="Center" Margin="12,0,0,0" />
                    </StackPanel>
                </StackPanel>
            </ScrollViewer>

            <!-- Step 2: Select Tables -->
            <Grid Visibility="{Binding CurrentStep, Converter={StaticResource StepToVis}, ConverterParameter=2}">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="*" />
                </Grid.RowDefinitions>

                <TextBlock Grid.Row="0" Text="Select Table" FontSize="14" FontWeight="SemiBold" Margin="0,0,0,8" />

                <ListBox Grid.Row="1" ItemsSource="{Binding AvailableTables}"
                         SelectedItem="{Binding SelectedTable}"
                         Background="{DynamicResource EditorBackground}"
                         Foreground="{DynamicResource PrimaryText}"
                         BorderBrush="{DynamicResource BorderBrush}">
                    <ListBox.ItemTemplate>
                        <DataTemplate>
                            <StackPanel Orientation="Horizontal" Margin="4,2">
                                <TextBlock Text="{Binding TableType}" Width="60" Foreground="#A0A0A0"
                                           FontSize="10" VerticalAlignment="Center" />
                                <TextBlock Text="{Binding FullName}" FontSize="13" />
                                <TextBlock Text=" (" Foreground="#A0A0A0" />
                                <TextBlock Text="{Binding Columns.Count}" Foreground="#A0A0A0" />
                                <TextBlock Text=" columns)" Foreground="#A0A0A0" />
                            </StackPanel>
                        </DataTemplate>
                    </ListBox.ItemTemplate>
                </ListBox>
            </Grid>

            <!-- Step 3: Configure Columns -->
            <Grid Visibility="{Binding CurrentStep, Converter={StaticResource StepToVis}, ConverterParameter=3}">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="*" />
                    <RowDefinition Height="Auto" />
                </Grid.RowDefinitions>

                <TextBlock Grid.Row="0" Text="Configure Columns" FontSize="14" FontWeight="SemiBold" Margin="0,0,0,8" />

                <DockPanel Grid.Row="1" Margin="0,0,0,8">
                    <TextBlock Text="Table Name:" VerticalAlignment="Center" />
                    <TextBox Text="{Binding TableDisplayName, UpdateSourceTrigger=PropertyChanged}"
                             Margin="8,0,0,0" Padding="6,4"
                             Background="{DynamicResource EditorBackground}"
                             Foreground="{DynamicResource PrimaryText}" />
                </DockPanel>

                <DataGrid Grid.Row="2" ItemsSource="{Binding Columns}"
                          AutoGenerateColumns="False"
                          Background="{DynamicResource EditorBackground}"
                          Foreground="{DynamicResource PrimaryText}"
                          BorderBrush="{DynamicResource BorderBrush}">
                    <DataGrid.Columns>
                        <DataGridCheckBoxColumn Header="Include" Binding="{Binding IsSelected, UpdateSourceTrigger=PropertyChanged}" Width="60" />
                        <DataGridTextColumn Header="Column Name" Binding="{Binding ColumnName, UpdateSourceTrigger=PropertyChanged}" Width="200" />
                        <DataGridTextColumn Header="Source Type" Binding="{Binding SourceDataType}" Width="150" IsReadOnly="True" />
                        <DataGridComboBoxColumn Header="Tabular Type" Width="120"
                                                 SelectedItemBinding="{Binding TabularDataType, UpdateSourceTrigger=PropertyChanged}" />
                        <DataGridCheckBoxColumn Header="Nullable" Binding="{Binding IsNullable, UpdateSourceTrigger=PropertyChanged}" Width="70" />
                    </DataGrid.Columns>
                </DataGrid>

                <StackPanel Grid.Row="3" Orientation="Horizontal" Margin="0,8,0,0">
                    <Button Content="Select All" Command="{Binding SelectAllColumnsCommand}" Padding="8,4" Margin="0,0,4,0" />
                    <Button Content="Deselect All" Command="{Binding DeselectAllColumnsCommand}" Padding="8,4" Margin="0,0,4,0" />
                    <Button Content="+ Add Column" Command="{Binding AddBlankColumnCommand}" Padding="8,4" />
                </StackPanel>
            </Grid>

            <!-- Step 4: Preview -->
            <Grid Visibility="{Binding CurrentStep, Converter={StaticResource StepToVis}, ConverterParameter=4}">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="*" />
                    <RowDefinition Height="Auto" />
                </Grid.RowDefinitions>

                <TextBlock Grid.Row="0" Text="Data Preview" FontSize="14" FontWeight="SemiBold" Margin="0,0,0,8" />

                <DataGrid Grid.Row="1" ItemsSource="{Binding PreviewData}"
                          AutoGenerateColumns="True" IsReadOnly="True"
                          Background="{DynamicResource EditorBackground}"
                          Foreground="{DynamicResource PrimaryText}"
                          BorderBrush="{DynamicResource BorderBrush}" />

                <TextBlock Grid.Row="2" Text="{Binding PreviewStatus}"
                           Foreground="{DynamicResource SecondaryText}" Margin="0,4,0,0" />
            </Grid>

            <!-- Step 5: Summary -->
            <Grid Visibility="{Binding CurrentStep, Converter={StaticResource StepToVis}, ConverterParameter=5}">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="*" />
                </Grid.RowDefinitions>

                <TextBlock Grid.Row="0" Text="Import Summary" FontSize="14" FontWeight="SemiBold" Margin="0,0,0,8" />

                <TextBox Grid.Row="1" Text="{Binding SummaryText, Mode=OneWay}"
                         IsReadOnly="True" TextWrapping="Wrap"
                         VerticalScrollBarVisibility="Auto"
                         FontFamily="Cascadia Code, Consolas, Courier New"
                         FontSize="12"
                         Background="{DynamicResource EditorBackground}"
                         Foreground="{DynamicResource PrimaryText}"
                         BorderBrush="{DynamicResource BorderBrush}"
                         Padding="12" />
            </Grid>
        </Grid>

        <!-- Bottom Buttons -->
        <Border Grid.Row="2" Background="{DynamicResource PanelHeaderBackground}"
                Padding="16,8" BorderBrush="{DynamicResource BorderBrush}" BorderThickness="0,1,0,0">
            <DockPanel>
                <Button DockPanel.Dock="Right" Content="Cancel" Padding="16,6"
                        Margin="4,0,0,0" IsCancel="True" Click="CancelButton_Click" />
                <Button DockPanel.Dock="Right" Content="{Binding NextButtonText}"
                        Command="{Binding GoNextCommand}"
                        IsEnabled="{Binding CanGoNext}"
                        Padding="16,6" Margin="4,0,0,0" />
                <Button DockPanel.Dock="Right" Content="&lt; Back"
                        Command="{Binding GoBackCommand}"
                        IsEnabled="{Binding CanGoBack}"
                        Padding="16,6" />

                <!-- Step indicator -->
                <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                    <TextBlock Text="Step " Foreground="{DynamicResource SecondaryText}" />
                    <TextBlock Foreground="{DynamicResource PrimaryText}">
                        <TextBlock.Text>
                            <MultiBinding StringFormat="{}{0} of 6">
                                <Binding Path="CurrentStep" Converter="{StaticResource StepNumberConverter}" />
                            </MultiBinding>
                        </TextBlock.Text>
                    </TextBlock>
                </StackPanel>
            </DockPanel>
        </Border>
    </Grid>
</Window>
